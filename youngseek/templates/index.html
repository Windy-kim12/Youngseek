<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YoungSeek | ìŠ¤ë§ˆíŠ¸ ì—¬í–‰ ê°€ê³„ë¶€</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --primary-color: #007aff;
        --primary-hover-color: #0056b3;
        --secondary-color: #6c757d;
        --danger-color: #dc3545;
        --background-color: #f7f9fc;
        --container-bg-color: #ffffff;
        --text-color: #333;
        --light-text-color: #666;
        --border-color: #e0e0e0;
        --shadow: 0 4px 15px rgba(35, 5, 5, 0.08);
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Noto Sans KR", sans-serif;
        margin: 0;
        display: flex;
        justify-content: center;
        flex-direction: column;
        align-items: center;
        background-color: var(--background-color);
        color: var(--text-color);
        padding: 20px 0;
        min-height: 100vh;
      }
      .container {
        width: 100%;
        max-width: 800px;
        background-color: var(--container-bg-color);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .main-content {
        padding: 40px 30px;
        text-align: center;
      }
      #country-selection-view,
      #file-upload-view,
      #chatbot-view {
        display: none;
      }
      #country-selection-view {
        display: block;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 30px;
        border-bottom: 1px solid var(--border-color);
      }
      .header .title {
        font-size: 24px;
        font-weight: 700;
        color: var(--primary-color);
      }
      .header .back-button {
        font-size: 16px;
        cursor: pointer;
        color: var(--light-text-color);
        font-weight: 500;
      }
      .header .header-title {
        font-size: 20px;
        font-weight: 700;
      }
      #header-details {
        display: none;
        width: 100%;
        justify-content: space-between;
        align-items: center;
      }
      .action-button,
      .file-select-button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 28px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
      }
      .action-button:hover,
      .file-select-button:hover {
        background-color: var(--primary-hover-color);
        transform: translateY(-2px);
      }
      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        color: white;
        text-align: center;
      }
      .loader {
        border: 6px solid #f3f3f3;
        border-radius: 50%;
        border-top: 6px solid var(--primary-color);
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .country-selection {
        display: flex;
        justify-content: center;
        gap: 25px;
        margin: 40px 0;
      }
      .country {
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 25px;
        width: 220px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        background-color: #fff;
      }
      .country:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow);
      }
      .country .flag {
        font-size: 20px;
      }
      .country .name {
        font-size: 24px;
        font-weight: 500;
        margin: 10px 0;
      }
      .country .currency {
        font-size: 16px;
        color: var(--light-text-color);
      }
      #upload-results-container {
        margin-top: 30px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
      }
      .receipt-card {
        border: 1px solid var(--border-color);
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .receipt-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background-color: #f7f9fc;
        border-bottom: 1px solid var(--border-color);
      }
      .receipt-card-header h2 {
        font-size: 18px;
        margin: 0;
        flex-grow: 1;
      }
      .receipt-card-body {
        padding: 15px;
        flex-grow: 1;
      }
      .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid #f5f5f5;
      }
      .info-item:last-child {
        border-bottom: none;
      }
      .info-item label,
      .info-item-total strong {
        font-weight: 500;
        color: #555;
      }
      .info-item-total {
        display: flex;
        justify-content: space-between;
        padding-top: 10px;
        margin-top: 10px;
        border-top: 2px solid #ddd;
      }
      .card-actions button {
        background: none;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 3px 8px;
        font-size: 12px;
        cursor: pointer;
        margin-left: 5px;
      }
      .card-actions .delete-btn {
        border-color: var(--danger-color);
        color: var(--danger-color);
      }
      .card-actions .edit-btn {
        border-color: var(--secondary-color);
        color: var(--secondary-color);
      }
      .card-actions .save-btn {
        display: none;
        border-color: var(--primary-color);
        color: var(--primary-color);
        font-weight: bold;
      }
      .editable-input {
        width: 60%;
        padding: 4px;
        border: 1px solid var(--primary-color);
        border-radius: 4px;
        text-align: right;
      }
      .main-actions {
        padding: 30px 0 10px;
        display: flex;
        justify-content: center;
        gap: 20px;
      }
      #chatbot-view {
        padding: 30px;
      }
      .chat-box {
        height: 450px;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 15px;
        overflow-y: auto;
        margin-bottom: 15px;
        background-color: #f7f9fc;
        display: flex;
        flex-direction: column;
      }
      .chat-message {
        margin-bottom: 12px;
        padding: 10px 15px;
        border-radius: 18px;
        max-width: 80%;
        line-height: 1.6;
        white-space: pre-wrap;
      }
      .user-message {
        background-color: var(--primary-color);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
      }
      .bot-message {
        background-color: #e9e9eb;
        color: var(--text-color);
        align-self: flex-start;
        border-bottom-left-radius: 4px;
      }
      .chat-input-area {
        display: flex;
        gap: 10px;
      }
      #chat-input {
        flex-grow: 1;
        padding: 10px 15px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 16px;
      }
      #chat-send-btn {
        padding: 0 15px;
        border: none;
        background-color: var(--primary-color);
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1999;
        padding: 20px;
      }
      .modal-content {
        background: white;
        padding: 25px 30px;
        border-radius: 16px;
        width: 100%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
      }
      .modal-close-btn {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 28px;
        font-weight: 300;
        cursor: pointer;
        border: none;
        background: none;
        color: #aaa;
      }
      .modal-body .report-section {
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 30px;
        align-items: center;
        margin-bottom: 25px;
        border-bottom: 1px solid #eee;
        padding-bottom: 25px;
      }
      .report-table {
        width: 100%;
        border-collapse: collapse;
      }
      .report-table th,
      .report-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #f0f0f0;
      }
      .report-table thead th {
        font-weight: 500;
        color: var(--light-text-color);
        border-bottom-width: 2px;
      }
      .report-table tbody tr:last-child {
        font-weight: 700;
        border-top: 2px solid #ddd;
      }
      .report-table .price-col {
        text-align: right;
        font-family: monospace, "Noto Sans KR";
      }
      @media (max-width: 768px) {
        .modal-body .report-section {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div id="loading-overlay">
      <div>
        <div class="loader"></div>
        <p id="loading-text">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>
    </div>
    <div class="container">
      <div class="header">
        <div id="header-default"><div class="title">YoungSeek</div></div>
        <div id="header-details">
          <div class="back-button">ì´ì „</div>
          <div id="header-title" class="header-title"></div>
          <div></div>
        </div>
      </div>

      <div id="country-selection-view" class="main-content">
        <div style="position: relative; display: inline-block">
          <img
            src="{{ url_for('static', filename='yongseek.png') }}"
            style="
              position: absolute;
              bottom: -150px;
              left: -350px;
              height: 160px;
            "
          />
        </div>
        <h2 style="font-weight: 400">ì˜ì‹ì´ì™€ í•¨ê»˜ í•˜ëŠ” ì—¬í–‰!!!</h2>

        <p style="color: var(--light-text-color)">
          í˜„ì¬ ì§€ì›ë˜ëŠ” êµ­ê°€ëŠ” ë…ì¼, ì¼ë³¸, ë¯¸êµ­ ì…ë‹ˆë‹¤.
        </p>

        <div class="country-selection">
          <div class="country" onclick="goToUploadView()">
            <div class="flag">
              ì‹œì‘í•˜ë ¤ë©´ <br />
              ì—¬ê¸¸ ëˆŒë ¤ì£¼ì„¸ìš”.
            </div>
            <div class="name"></div>
            <div class="currency"></div>
          </div>
        </div>
      </div>
      <div id="file-upload-view" class="main-content">
        <label for="file-input" class="action-button">ğŸ“‚ ì˜ìˆ˜ì¦ ì—…ë¡œë“œ</label
        ><input
          id="file-input"
          type="file"
          accept="image/jpeg, image/png"
          onchange="processFiles(this.files)"
          multiple
          style="display: none"
        />
        <span id="pre-upload-actions">
          <button
            class="action-button go-to-chat-btn"
            style="background-color: var(--secondary-color)"
          >
            ğŸ¤– ì˜ì‹ì´ì™€ ëŒ€í™”í•˜ê¸°
          </button>
          <button
            class="action-button show-ledger-btn"
            style="background-color: #16a085"
          >
            ğŸ“– ì „ì²´ ê°€ê³„ë¶€ ë³´ê¸°
          </button>
        </span>
        <div id="upload-results-container"></div>
        <div
          id="post-upload-actions"
          style="display: none; border-top: 1px solid #eee; margin-top: 30px"
          class="main-actions"
        >
          <button id="generate-report-btn" class="action-button">
            ğŸ“Š ì§€ì¶œ ìš”ì•½ ë¦¬í¬íŠ¸</button
          ><button
            class="action-button go-to-chat-btn"
            style="background-color: var(--secondary-color)"
          >
            ğŸ¤– ì˜ì‹ì´ì™€ ëŒ€í™”í•˜ê¸°
          </button>
          <button
            class="action-button show-ledger-btn"
            style="background-color: #16a085"
          >
            ğŸ“– ì „ì²´ ê°€ê³„ë¶€ ë³´ê¸°
          </button>
        </div>
      </div>

      <div id="chatbot-view">
        <div class="chat-container">
          <div class="chat-box" id="chat-box"></div>
          <div class="chat-input-area">
            <input
              type="text"
              id="chat-input"
              placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
            /><button id="chat-send-btn">ì „ì†¡</button>
          </div>
        </div>
      </div>
    </div>

    <div id="report-modal" class="modal-overlay">
      <div class="modal-content">
        <button id="ledger-modal-close-btn" class="ledger-modal-close-btn">
          Ã—
        </button>
        <h2>ğŸ“Š í˜„ì¬ ì„¸ì…˜ ì§€ì¶œ ìš”ì•½</h2>
        <p
          style="
            text-align: center;
            color: #555;
            margin-top: -10px;
            font-size: 14px;
          "
        >
          (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤)
        </p>
        <hr style="border-color: #eee; margin: 15px 0" />
        <div id="report-body" class="modal-body"></div>
      </div>
    </div>

    <div id="ledger-modal" class="modal-overlay">
      <div class="modal-content">
        <button id="all-modal-close-btn" class="modal-close-btn">Ã—</button>
        <h2>ğŸ“– ì „ì²´ ì§€ì¶œ ê°€ê³„ë¶€ ë³´ê¸°</h2>
        <p
          style="
            text-align: center;
            color: #555;
            margin-top: -10px;
            font-size: 14px;
          "
        >
          (ì§€ê¸ˆê¹Œì§€ ì—…ë¡œë“œí•œ ëª¨ë“  ì˜ìˆ˜ì¦ ê¸°ì¤€)
        </p>
        <div style="margin: 15px 0; text-align: right">
          <label for="country-filter">êµ­ê°€ ì„ íƒ: </label>
          <select
            id="country-filter"
            style="padding: 8px; border-radius: 5px; border: 1px solid #ccc"
          >
            <!-- ì˜µì…˜ì€ ìë°”ìŠ¤í¬ë¦½íŠ¸ê°€ ì±„ì›Œì¤„ ì˜ˆì • -->
          </select>
        </div>
        <hr style="border-color: #eee; margin: 15px 0" />
        <div id="ledger-body" class="modal-body"></div>
      </div>
    </div>

    <script>
      const loadingOverlay = document.getElementById("loading-overlay"),
        loadingText = document.getElementById("loading-text");
      const countryView = document.getElementById("country-selection-view"),
        uploadView = document.getElementById("file-upload-view"),
        chatbotView = document.getElementById("chatbot-view");
      const headerDefault = document.getElementById("header-default"),
        headerDetails = document.getElementById("header-details"),
        headerTitle = document.getElementById("header-title");
      const resultsContainer = document.getElementById(
          "upload-results-container"
        ),
        postUploadActions = document.getElementById("post-upload-actions");
      const chatBox = document.getElementById("chat-box"),
        chatInput = document.getElementById("chat-input");
      const reportModal = document.getElementById("report-modal"),
        reportBody = document.getElementById("report-body");
      const ledgerModal = document.getElementById("ledger-modal"),
        ledgerBody = document.getElementById("ledger-body");

      let currentSessionData = [],
        activeCharts = [],
        chatHistory = [];

      function switchView(showView, title = null) {
        [countryView, uploadView, chatbotView].forEach(
          (v) => (v.style.display = "none")
        );
        showView.style.display = "block";
        headerDefault.style.display = title ? "none" : "flex";
        headerDetails.style.display = title ? "flex" : "none";
        if (title) headerTitle.textContent = title;
      }
      function goToUploadView() {
        switchView(uploadView, "ì˜ìˆ˜ì¦ ì—…ë¡œë“œ ë° í™•ì¸");
      }
      function goToChatView() {
        switchView(chatbotView, "ê°€ê³„ë¶€ ë¹„ì„œ ì˜ì‹ì´");
        if (chatHistory.length === 0) {
          addMessageToChatBox(
            "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ê°€ê³„ë¶€ ë¹„ì„œ 'ì˜ì‹ì´'ì…ë‹ˆë‹¤. ğŸ¤–\ní˜„ì¬ ì„¸ì…˜ì— ì—…ë¡œë“œëœ ì˜ìˆ˜ì¦ì— ëŒ€í•´ ì§ˆë¬¸í•˜ê±°ë‚˜, ì¼ìƒì ì¸ ëŒ€í™”ë¥¼ ë‚˜ëˆ ë³´ì„¸ìš”!",
            "bot"
          );
        }
      }

      headerDetails
        .querySelector(".back-button")
        .addEventListener("click", () => {
          if (chatbotView.style.display === "block") {
            switchView(uploadView, "ì˜ìˆ˜ì¦ ì—…ë¡œë“œ ë° í™•ì¸");
          } else {
            switchView(countryView);
            currentSessionData = [];
            resultsContainer.innerHTML = "";
            postUploadActions.style.display = "none";
            chatHistory = [];
          }
        });
      document.querySelectorAll(".go-to-chat-btn").forEach((button) => {
        button.addEventListener("click", goToChatView);
      });

      document
        .getElementById("generate-report-btn")
        .addEventListener("click", generateReport);
      document
        .getElementById("chat-send-btn")
        .addEventListener("click", sendTextMessage);
      chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendTextMessage();
      });
      document
        .getElementById("ledger-modal-close-btn")
        .addEventListener("click", () => {
          reportModal.style.display = "none";
          activeCharts.forEach((c) => c.destroy());
        });

      async function processFiles(files) {
        if (!files.length) return;
        loadingText.textContent = `ì˜ìˆ˜ì¦ ${files.length}ê°œ ì²˜ë¦¬ ì¤‘...`;
        loadingOverlay.style.display = "flex";

        for (const file of files) {
          const formData = new FormData();
          formData.append("receiptImage", file); // app.pyì˜ request.files['receiptImage']ì™€ ì¼ì¹˜

          try {
            const response = await fetch("/upload", {
              // app.pyì˜ /upload API í˜¸ì¶œ
              method: "POST",
              body: formData,
            });

            // response.okê°€ ì•„ë‹ ë•Œë„ JSON íŒŒì‹±ì„ ì‹œë„ (ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë°›ê¸° ìœ„í•´)
            const data = await response.json();

            if (!response.ok) {
              // ì„œë²„ê°€ ë³´ë‚¸ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©
              throw new Error(
                data.error || "ì„œë²„ ì²˜ë¦¬ ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë°œìƒ"
              );
            }

            // ì„±ê³µ ì‹œ ë¡œì§
            currentSessionData.push({
              data: data.receiptData,
              filename: data.filename,
            });
            resultsContainer.insertAdjacentHTML(
              "beforeend",
              createReceiptCardHTML(data.receiptData, data.filename)
            );

            // ì—…ë¡œë“œëœ ì˜ìˆ˜ì¦ì´ í•˜ë‚˜ ì´ìƒ ìˆìœ¼ë©´
            if (currentSessionData.length > 0) {
              // 1. í•˜ë‹¨ ë²„íŠ¼ ê·¸ë£¹ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
              postUploadActions.style.display = "flex";

              // 2. ìƒë‹¨ ë²„íŠ¼ ê·¸ë£¹ì„ ìˆ¨ê¹ë‹ˆë‹¤.
              document.getElementById("pre-upload-actions").style.display =
                "none";

              // 3. (ì„ íƒì‚¬í•­) 'ì˜ìˆ˜ì¦ ì—…ë¡œë“œ' ë²„íŠ¼ í…ìŠ¤íŠ¸ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
              document.querySelector('label[for="file-input"]').innerHTML =
                "ğŸ“‚ ì˜ìˆ˜ì¦ ì¶”ê°€í•˜ê¸°";
            }
          } catch (error) {
            // ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ì¹´ë“œ í‘œì‹œ
            resultsContainer.insertAdjacentHTML(
              "beforeend",
              `<div class="receipt-card"><h2>${file.name} ì²˜ë¦¬ ì‹¤íŒ¨</h2><p style="color:red;padding:15px;">${error.message}</p></div>`
            );
          }
        }
        loadingOverlay.style.display = "none";
      }

      function createReceiptCardHTML(data, filename) {
        let itemsHTML = data.items
          .map(
            (item, index) =>
              `<div class="info-item" data-item-index="${index}"><span class="editable" data-field="itemName">${item.name}</span><span><span class="editable" data-field="itemPrice">${item.price}</span> ${data.currency}</span></div>`
          )
          .join("");
        return `<div class="receipt-card" data-filename="${filename}"><div class="receipt-card-header"><h2><span class="editable" data-field="merchantName">${data.merchantName}</span></h2><div class="card-actions"><button class="edit-btn">ìˆ˜ì •</button><button class="save-btn">ì €ì¥</button><button class="delete-btn">ì‚­ì œ</button></div></div><div class="receipt-card-body"><div class="info-item"><label>ê±°ë˜ì¼:</label><span class="editable" data-field="transactionDate">${data.transactionDate}</span></div><h4 style="margin:15px 0 5px; font-weight:500;">êµ¬ë§¤ í’ˆëª©</h4><div class="item-list">${itemsHTML}</div><div class="info-item-total"><strong>ì´ì•¡:</strong><strong><span class="editable" data-field="total">${data.total}</span> ${data.currency}</strong></div></div></div>`;
      }

      resultsContainer.addEventListener("click", async (e) => {
        const card = e.target.closest(".receipt-card");
        if (!card) return;
        if (e.target.classList.contains("delete-btn")) {
          if (!confirm("ì´ ì˜ìˆ˜ì¦ì„ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
          const filename = card.dataset.filename;
          loadingOverlay.style.display = "flex";
          try {
            const response = await fetch("/delete-receipt", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ filename }),
            });
            if (!response.ok) throw new Error("ì„œë²„ ì‚­ì œ ì‹¤íŒ¨");
            currentSessionData = currentSessionData.filter(
              (item) => item.filename !== filename
            );
            card.remove();
          } catch (error) {
            alert(`ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
          } finally {
            loadingOverlay.style.display = "none";
          }
        }
        if (e.target.classList.contains("edit-btn")) {
          card.querySelectorAll(".editable").forEach((span) => {
            const input = document.createElement("input");
            input.type = "text";
            input.value = span.textContent;
            input.className = "editable-input";
            span.style.display = "none";
            span.parentNode.insertBefore(input, span.nextSibling);
          });
          e.target.style.display = "none";
          card.querySelector(".save-btn").style.display = "inline-block";
        }
        if (e.target.classList.contains("save-btn")) {
          const filename = card.dataset.filename;
          const sessionItem = currentSessionData.find(
            (item) => item.filename === filename
          );
          if (!sessionItem) return;
          card.querySelectorAll(".editable").forEach((span) => {
            const input = span.nextSibling;
            const newValue = input.value;
            const field = span.dataset.field;
            span.textContent = newValue;
            span.style.display = "inline";
            input.remove();
            if (field === "merchantName")
              sessionItem.data.merchantName = newValue;
            else if (field === "transactionDate")
              sessionItem.data.transactionDate = newValue;
            else if (field === "total") sessionItem.data.total = newValue;
            else if (field === "itemName" || field === "itemPrice") {
              const itemIndex = span.closest(".info-item").dataset.itemIndex;
              const key = field === "itemName" ? "name" : "price";
              sessionItem.data.items[itemIndex][key] = newValue;
            }
          });
          e.target.style.display = "none";
          card.querySelector(".edit-btn").style.display = "inline-block";
        }
      });

      async function sendTextMessage() {
        const prompt = chatInput.value.trim();
        if (!prompt) return;
        addMessageToChatBox(prompt, "user");
        chatInput.value = "";
        addMessageToChatBox("ìƒê° ì¤‘... ğŸ¤–", "bot", true);
        try {
          const payload = {
            prompt: prompt,
            session_data: currentSessionData,
            history: chatHistory,
          };
          const response = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await response.json();
          document.getElementById("thinking-msg")?.remove();
          if (!response.ok) throw new Error(data.error);
          addMessageToChatBox(data.response, "bot");
          chatHistory.push({ role: "user", content: prompt });
          chatHistory.push({ role: "assistant", content: data.response });
        } catch (error) {
          document.getElementById("thinking-msg")?.remove();
          addMessageToChatBox(`ì±—ë´‡ ì˜¤ë¥˜: ${error.message}`, "bot");
        }
      }

      function addMessageToChatBox(message, sender, isThinking = false) {
        if (isThinking) document.getElementById("thinking-msg")?.remove();
        const msgEl = document.createElement("div");
        msgEl.className = `chat-message ${sender}-message`;
        msgEl.textContent = message;
        if (isThinking) msgEl.id = "thinking-msg";
        chatBox.appendChild(msgEl);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      async function generateReport() {
        if (currentSessionData.length === 0)
          return alert(
            "ë¶„ì„í•  ì˜ìˆ˜ì¦ì´ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € ì˜ìˆ˜ì¦ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”."
          );

        loadingText.textContent = "ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...";
        loadingOverlay.style.display = "flex";

        try {
          const response = await fetch("/generate-web-report", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(currentSessionData),
          });
          const data = await response.json();
          if (!response.ok) throw new Error(data.error);

          activeCharts.forEach((c) => c.destroy());
          activeCharts = [];
          reportBody.innerHTML = "";

          if (Object.keys(data).length === 0) {
            reportBody.innerHTML =
              '<p style="text-align:center;">ë¶„ì„í•  ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          } else {
            for (const currency in data) {
              const reportData = data[currency];

              // [ìˆ˜ì •] 1. í†µí™”ë³„ ë¦¬í¬íŠ¸ ì „ì²´ë¥¼ ê°ì‹¸ëŠ” ìµœìƒìœ„ ì»¨í…Œì´ë„ˆ ìƒì„±
              const reportContainer = document.createElement("div");
              reportContainer.style.marginBottom = "30px"; // ë¦¬í¬íŠ¸ ê°„ ê°„ê²© ì¶”ê°€

              // 2. ì œëª© ìƒì„± (ì´ì „ ì½”ë“œì™€ ê±°ì˜ ë™ì¼)
              const titleElement = document.createElement("h4"); // h5ë³´ë‹¤ h4ê°€ ë” ì í•©
              const krwTotalFormatted = Math.round(
                reportData.total_krw
              ).toLocaleString();
              titleElement.innerHTML = `${currency} ì§€ì¶œ <br> ì´ì•¡: ${reportData.total_orig.toFixed(
                2
              )} ${currency} / â‚©${krwTotalFormatted}<br><span style="font-size: 13px; color: #666; font-weight: 400;">ì ìš©í™˜ìœ¨: 1 ${currency} = ${
                reportData.exchange_rate
              }ì›</span>`;
              titleElement.style.textAlign = "left";
              titleElement.style.fontWeight = "500";
              titleElement.style.lineHeight = "1.5";
              titleElement.style.marginBottom = "15px";

              // 3. [ìˆ˜ì •] í…Œì´ë¸”ê³¼ ì°¨íŠ¸ë§Œ ë‹´ì„ 'ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆ' ë³„ë„ ìƒì„±
              const contentGrid = document.createElement("div");
              contentGrid.className = "report-section"; // ë‚˜ë€íˆ ë°°ì¹˜í•˜ëŠ” ìŠ¤íƒ€ì¼ì€ ì—¬ê¸°ì—ë§Œ ì ìš©

              const tableHtml = `
                    <div class="report-table-container">
                        <table class="report-table">
                            <thead><tr><th>ì¹´í…Œê³ ë¦¬</th><th class="price-col">ê¸ˆì•¡</th><th class="price-col">ì›í™”(â‚©)</th></tr></thead>
                            <tbody>
                                ${reportData.table_data
                                  .map(
                                    (r) => `
                                    <tr>
                                        <td>${r.ì¹´í…Œê³ ë¦¬}</td>
                                        <td class="price-col">${r.ê°€ê²©.toFixed(
                                          2
                                        )}</td>
                                        <td class="price-col">${Math.round(
                                          r.ì›í™”ê°€ê²©
                                        ).toLocaleString()}</td>
                                    </tr>`
                                  )
                                  .join("")}
                                <tr>
                                    <th>ì´í•©</th>
                                    <td class="price-col">${reportData.total_orig.toFixed(
                                      2
                                    )}</td>
                                    <td class="price-col">${Math.round(
                                      reportData.total_krw
                                    ).toLocaleString()}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>`;

              const chartContainer = document.createElement("div");
              chartContainer.className = "report-chart-container";
              const canvas = document.createElement("canvas");
              chartContainer.appendChild(canvas);

              // [ìˆ˜ì •] 4. ì¡°ë¦½ ìˆœì„œ ë³€ê²½
              contentGrid.insertAdjacentHTML("beforeend", tableHtml); // ê·¸ë¦¬ë“œì— í…Œì´ë¸” ì¶”ê°€
              contentGrid.appendChild(chartContainer); // ê·¸ë¦¬ë“œì— ì°¨íŠ¸ ì¶”ê°€

              reportContainer.appendChild(titleElement); // ì „ì²´ ì»¨í…Œì´ë„ˆì— ì œëª©ì„ ë§¨ ìœ„ì— ì¶”ê°€
              reportContainer.appendChild(contentGrid); // ì „ì²´ ì»¨í…Œì´ë„ˆì— ê·¸ë¦¬ë“œë¥¼ ì•„ë˜ì— ì¶”ê°€

              reportBody.appendChild(reportContainer); // ìµœì¢…ì ìœ¼ë¡œ ì¡°ë¦½ëœ ë¦¬í¬íŠ¸ë¥¼ ëª¨ë‹¬ì— ì¶”ê°€

              activeCharts.push(
                new Chart(canvas.getContext("2d"), {
                  type: "pie",
                  data: {
                    labels: reportData.chart_labels,
                    datasets: [
                      {
                        data: reportData.chart_data,
                        backgroundColor: [
                          "#d946ef",
                          "#f97316",
                          "#14b8a6",
                          "#3b82f6",
                          "#8b5cf6",
                          "#ef4444",
                          "#84cc16",
                        ],
                        borderColor: "#fff",
                      },
                    ],
                  },
                  options: {
                    responsive: true,
                    plugins: { legend: { position: "right" } },
                  },
                })
              );
            }
          }
          reportModal.style.display = "flex";
        } catch (error) {
          alert(`ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨: ${error.message}`);
        } finally {
          loadingOverlay.style.display = "none";
        }
      }

      document
        .getElementById("all-modal-close-btn")
        .addEventListener("click", () => {
          ledgerModal.style.display = "none";
        });

      document.querySelectorAll(".show-ledger-btn").forEach((button) => {
        button.addEventListener("click", showFullLedger);
      });

      let fullLedgerData = {};

      async function showFullLedger() {
        loadingText.textContent = "ì „ì²´ ê°€ê³„ë¶€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
        loadingOverlay.style.display = "flex";
        try {
          const response = await fetch("/get-ledger");
          const data = await response.json();
          if (!response.ok) throw new Error(data.error);

          fullLedgerData = data; // ë°›ì•„ì˜¨ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥

          // ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ì±„ìš°ê¸°
          const countryFilter = document.getElementById("country-filter");
          countryFilter.innerHTML = '<option value="ì „ì²´">ì „ì²´ ë³´ê¸°</option>'; // ê¸°ë³¸ ì˜µì…˜

          for (const country in fullLedgerData) {
            const option = document.createElement("option");
            option.value = country;
            option.textContent = country;
            countryFilter.appendChild(option);
          }

          // ë“œë¡­ë‹¤ìš´ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (í•œ ë²ˆë§Œ)
          // ì´ì „ì— ì¶”ê°€ëœ ë¦¬ìŠ¤ë„ˆê°€ ìˆë‹¤ë©´ ì¤‘ë³µì„ ë§‰ê¸° ìœ„í•´ ì•„ë˜ì™€ ê°™ì´ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          countryFilter.replaceWith(countryFilter.cloneNode(true)); // ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
          document
            .getElementById("country-filter")
            .addEventListener("change", (e) => {
              displayLedgerByCountry(e.target.value);
            });

          // ì²˜ìŒì—ëŠ” ì „ì²´ ë°ì´í„°ë¥¼ ë³´ì—¬ì¤Œ
          displayLedgerByCountry("ì „ì²´");

          ledgerModal.style.display = "flex";
        } catch (error) {
          alert(`ê°€ê³„ë¶€ ë¡œë”© ì‹¤íŒ¨: ${error.message}`);
        } finally {
          loadingOverlay.style.display = "none";
        }
      }

      // ë°ì´í„°ë¥¼ í™”ë©´ì— ê·¸ë ¤ì£¼ëŠ” í•¨ìˆ˜ (ì—…ê·¸ë ˆì´ë“œë¨)
      function displayLedgerByCountry(selectedCountry) {
        const ledgerBody = document.getElementById("ledger-body");
        ledgerBody.innerHTML = ""; // ì´ì „ ë‚´ìš© ë¹„ìš°ê¸°

        if (Object.keys(fullLedgerData).length === 0) {
          ledgerBody.innerHTML =
            '<p style="text-align:center;">ì²˜ë¦¬ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        const countriesToShow =
          selectedCountry === "ì „ì²´"
            ? Object.keys(fullLedgerData)
            : [selectedCountry];

        countriesToShow.forEach((country) => {
          if (!fullLedgerData[country]) return;

          const countryData = fullLedgerData[country];
          const countryTotalOrig = countryData.total_orig.toFixed(2);
          const countryTotalKRW = Math.round(
            countryData.total_krw
          ).toLocaleString();

          const countrySection = document.createElement("div");
          // h3 ì œëª©ì— í˜„ì§€ í†µí™” ì´ì•¡ê³¼ ì›í™” ì´ì•¡ì„ ëª¨ë‘ í‘œì‹œ
          countrySection.innerHTML = `
            <h3 style="margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
                ${country} (ì´ ì§€ì¶œ: ${countryTotalOrig} ${
            countryData.currency
          } / â‚©${countryTotalKRW})
            </h3>
            <table class="report-table" style="width: 100%;">
                <thead>
                    <tr>
                        <th>ì¹´í…Œê³ ë¦¬</th>
                        <th class="price-col">í˜„ì§€ ê¸ˆì•¡</th>
                        <th class="price-col">ì›í™”(â‚©) í•©ê³„</th>
                    </tr>
                </thead>
                <tbody>
                    ${countryData.data
                      .map(
                        (item) => `
                            <tr>
                                <td>${item.category}</td>
                                <td class="price-col">${item.total_orig.toFixed(
                                  2
                                )} ${countryData.currency}</td>
                                <td class="price-col">${Math.round(
                                  item.total_krw
                                ).toLocaleString()}</td>
                            </tr>
                        `
                      )
                      .join("")}
                    <tr style="font-weight: bold; border-top: 2px solid #ddd;">
                        <td>ì´í•©</td>
                        <td class="price-col">${countryTotalOrig} ${
            countryData.currency
          }</td>
                        <td class="price-col">â‚©${countryTotalKRW}</td>
                    </tr>
                </tbody>
            </table>
        `;
          ledgerBody.appendChild(countrySection);
        });
      }
    </script>
    <footer
      style="text-align: center; padding: 20px; font-size: 12px; color: #888"
    >
      ì˜ì‹ì´(YoungSeek)ì´ê°€ ë” ë˜‘ë˜‘í•´ì§ˆ ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ì„¸ìš”! ë°œê²¬í•œ ì˜¤ë¥˜ë‚˜ ê°œì„ 
      ì•„ì´ë””ì–´ë¥¼
      <a
        href="mailto:your_email@example.com"
        style="color: #555; text-decoration: none"
      >
        YoungSeekJJang@microsoftaischool.com
      </a>
      ìœ¼ë¡œ ë³´ë‚´ì£¼ì„¸ìš”!
    </footer>
  </body>
</html>
