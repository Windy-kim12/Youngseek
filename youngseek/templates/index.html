<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YoungSeek | 스마트 여행 가계부</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --primary-color: #007aff;
        --primary-hover-color: #0056b3;
        --secondary-color: #6c757d;
        --danger-color: #dc3545;
        --background-color: #f7f9fc;
        --container-bg-color: #ffffff;
        --text-color: #333;
        --light-text-color: #666;
        --border-color: #e0e0e0;
        --shadow: 0 4px 15px rgba(35, 5, 5, 0.08);
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Noto Sans KR", sans-serif;
        margin: 0;
        display: flex;
        justify-content: center;
        flex-direction: column;
        align-items: center;
        background-color: var(--background-color);
        color: var(--text-color);
        padding: 20px 0;
        min-height: 100vh;
      }
      .container {
        width: 100%;
        max-width: 800px;
        background-color: var(--container-bg-color);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .main-content {
        padding: 40px 30px;
        text-align: center;
      }
      #country-selection-view,
      #file-upload-view,
      #chatbot-view {
        display: none;
      }
      #country-selection-view {
        display: block;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 30px;
        border-bottom: 1px solid var(--border-color);
      }
      .header .title {
        font-size: 24px;
        font-weight: 700;
        color: var(--primary-color);
      }
      .header .back-button {
        font-size: 16px;
        cursor: pointer;
        color: var(--light-text-color);
        font-weight: 500;
      }
      .header .header-title {
        font-size: 20px;
        font-weight: 700;
      }
      #header-details {
        display: none;
        width: 100%;
        justify-content: space-between;
        align-items: center;
      }
      .action-button,
      .file-select-button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 28px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
      }
      .action-button:hover,
      .file-select-button:hover {
        background-color: var(--primary-hover-color);
        transform: translateY(-2px);
      }
      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        color: white;
        text-align: center;
      }
      .loader {
        border: 6px solid #f3f3f3;
        border-radius: 50%;
        border-top: 6px solid var(--primary-color);
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .country-selection {
        display: flex;
        justify-content: center;
        gap: 25px;
        margin: 40px 0;
      }
      .country {
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 25px;
        width: 220px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        background-color: #fff;
      }
      .country:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow);
      }
      .country .flag {
        font-size: 20px;
      }
      .country .name {
        font-size: 24px;
        font-weight: 500;
        margin: 10px 0;
      }
      .country .currency {
        font-size: 16px;
        color: var(--light-text-color);
      }
      #upload-results-container {
        margin-top: 30px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
      }
      .receipt-card {
        border: 1px solid var(--border-color);
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .receipt-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background-color: #f7f9fc;
        border-bottom: 1px solid var(--border-color);
      }
      .receipt-card-header h2 {
        font-size: 18px;
        margin: 0;
        flex-grow: 1;
      }
      .receipt-card-body {
        padding: 15px;
        flex-grow: 1;
      }
      .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid #f5f5f5;
      }
      .info-item:last-child {
        border-bottom: none;
      }
      .info-item label,
      .info-item-total strong {
        font-weight: 500;
        color: #555;
      }
      .info-item-total {
        display: flex;
        justify-content: space-between;
        padding-top: 10px;
        margin-top: 10px;
        border-top: 2px solid #ddd;
      }
      .card-actions button {
        background: none;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 3px 8px;
        font-size: 12px;
        cursor: pointer;
        margin-left: 5px;
      }
      .card-actions .delete-btn {
        border-color: var(--danger-color);
        color: var(--danger-color);
      }
      .card-actions .edit-btn {
        border-color: var(--secondary-color);
        color: var(--secondary-color);
      }
      .card-actions .save-btn {
        display: none;
        border-color: var(--primary-color);
        color: var(--primary-color);
        font-weight: bold;
      }
      .editable-input {
        width: 60%;
        padding: 4px;
        border: 1px solid var(--primary-color);
        border-radius: 4px;
        text-align: right;
      }
      .main-actions {
        padding: 30px 0 10px;
        display: flex;
        justify-content: center;
        gap: 20px;
      }
      #chatbot-view {
        padding: 30px;
      }
      .chat-box {
        height: 450px;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 15px;
        overflow-y: auto;
        margin-bottom: 15px;
        background-color: #f7f9fc;
        display: flex;
        flex-direction: column;
      }
      .chat-message {
        margin-bottom: 12px;
        padding: 10px 15px;
        border-radius: 18px;
        max-width: 80%;
        line-height: 1.6;
        white-space: pre-wrap;
      }
      .user-message {
        background-color: var(--primary-color);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
      }
      .bot-message {
        background-color: #e9e9eb;
        color: var(--text-color);
        align-self: flex-start;
        border-bottom-left-radius: 4px;
      }
      .chat-input-area {
        display: flex;
        gap: 10px;
      }
      #chat-input {
        flex-grow: 1;
        padding: 10px 15px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 16px;
      }
      #chat-send-btn {
        padding: 0 15px;
        border: none;
        background-color: var(--primary-color);
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1999;
        padding: 20px;
      }
      .modal-content {
        background: white;
        padding: 25px 30px;
        border-radius: 16px;
        width: 100%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
      }
      .modal-close-btn {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 28px;
        font-weight: 300;
        cursor: pointer;
        border: none;
        background: none;
        color: #aaa;
      }
      .modal-body .report-section {
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 30px;
        align-items: center;
        margin-bottom: 25px;
        border-bottom: 1px solid #eee;
        padding-bottom: 25px;
      }
      .report-table {
        width: 100%;
        border-collapse: collapse;
      }
      .report-table th,
      .report-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #f0f0f0;
      }
      .report-table thead th {
        font-weight: 500;
        color: var(--light-text-color);
        border-bottom-width: 2px;
      }
      .report-table tbody tr:last-child {
        font-weight: 700;
        border-top: 2px solid #ddd;
      }
      .report-table .price-col {
        text-align: right;
        font-family: monospace, "Noto Sans KR";
      }
      @media (max-width: 768px) {
        .modal-body .report-section {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div id="loading-overlay">
      <div>
        <div class="loader"></div>
        <p id="loading-text">처리 중입니다...</p>
      </div>
    </div>
    <div class="container">
      <div class="header">
        <div id="header-default"><div class="title">YoungSeek</div></div>
        <div id="header-details">
          <div class="back-button">이전</div>
          <div id="header-title" class="header-title"></div>
          <div></div>
        </div>
      </div>

      <div id="country-selection-view" class="main-content">
        <div style="position: relative; display: inline-block">
          <img
            src="{{ url_for('static', filename='yongseek.png') }}"
            style="
              position: absolute;
              bottom: -150px;
              left: -350px;
              height: 160px;
            "
          />
        </div>
        <h2 style="font-weight: 400">영식이와 함께 하는 여행!!!</h2>

        <p style="color: var(--light-text-color)">
          현재 지원되는 국가는 독일, 일본, 미국 입니다.
        </p>

        <div class="country-selection">
          <div class="country" onclick="goToUploadView()">
            <div class="flag">
              시작하려면 <br />
              여길 눌려주세요.
            </div>
            <div class="name"></div>
            <div class="currency"></div>
          </div>
        </div>
      </div>
      <div id="file-upload-view" class="main-content">
        <label for="file-input" class="action-button">📂 영수증 업로드</label
        ><input
          id="file-input"
          type="file"
          accept="image/jpeg, image/png"
          onchange="processFiles(this.files)"
          multiple
          style="display: none"
        />
        <span id="pre-upload-actions">
          <button
            class="action-button go-to-chat-btn"
            style="background-color: var(--secondary-color)"
          >
            🤖 영식이와 대화하기
          </button>
          <button
            class="action-button show-ledger-btn"
            style="background-color: #16a085"
          >
            📖 전체 가계부 보기
          </button>
        </span>
        <div id="upload-results-container"></div>
        <div
          id="post-upload-actions"
          style="display: none; border-top: 1px solid #eee; margin-top: 30px"
          class="main-actions"
        >
          <button id="generate-report-btn" class="action-button">
            📊 지출 요약 리포트</button
          ><button
            class="action-button go-to-chat-btn"
            style="background-color: var(--secondary-color)"
          >
            🤖 영식이와 대화하기
          </button>
          <button
            class="action-button show-ledger-btn"
            style="background-color: #16a085"
          >
            📖 전체 가계부 보기
          </button>
        </div>
      </div>

      <div id="chatbot-view">
        <div class="chat-container">
          <div class="chat-box" id="chat-box"></div>
          <div class="chat-input-area">
            <input
              type="text"
              id="chat-input"
              placeholder="메시지를 입력하세요..."
            /><button id="chat-send-btn">전송</button>
          </div>
        </div>
      </div>
    </div>

    <div id="report-modal" class="modal-overlay">
      <div class="modal-content">
        <button id="ledger-modal-close-btn" class="ledger-modal-close-btn">
          ×
        </button>
        <h2>📊 현재 세션 지출 요약</h2>
        <p
          style="
            text-align: center;
            color: #555;
            margin-top: -10px;
            font-size: 14px;
          "
        >
          (페이지 새로고침 시 초기화됩니다)
        </p>
        <hr style="border-color: #eee; margin: 15px 0" />
        <div id="report-body" class="modal-body"></div>
      </div>
    </div>

    <div id="ledger-modal" class="modal-overlay">
      <div class="modal-content">
        <button id="all-modal-close-btn" class="modal-close-btn">×</button>
        <h2>📖 전체 지출 가계부 보기</h2>
        <p
          style="
            text-align: center;
            color: #555;
            margin-top: -10px;
            font-size: 14px;
          "
        >
          (지금까지 업로드한 모든 영수증 기준)
        </p>
        <div style="margin: 15px 0; text-align: right">
          <label for="country-filter">국가 선택: </label>
          <select
            id="country-filter"
            style="padding: 8px; border-radius: 5px; border: 1px solid #ccc"
          >
            <!-- 옵션은 자바스크립트가 채워줄 예정 -->
          </select>
        </div>
        <hr style="border-color: #eee; margin: 15px 0" />
        <div id="ledger-body" class="modal-body"></div>
      </div>
    </div>

    <script>
      const loadingOverlay = document.getElementById("loading-overlay"),
        loadingText = document.getElementById("loading-text");
      const countryView = document.getElementById("country-selection-view"),
        uploadView = document.getElementById("file-upload-view"),
        chatbotView = document.getElementById("chatbot-view");
      const headerDefault = document.getElementById("header-default"),
        headerDetails = document.getElementById("header-details"),
        headerTitle = document.getElementById("header-title");
      const resultsContainer = document.getElementById(
          "upload-results-container"
        ),
        postUploadActions = document.getElementById("post-upload-actions");
      const chatBox = document.getElementById("chat-box"),
        chatInput = document.getElementById("chat-input");
      const reportModal = document.getElementById("report-modal"),
        reportBody = document.getElementById("report-body");
      const ledgerModal = document.getElementById("ledger-modal"),
        ledgerBody = document.getElementById("ledger-body");

      let currentSessionData = [],
        activeCharts = [],
        chatHistory = [];

      function switchView(showView, title = null) {
        [countryView, uploadView, chatbotView].forEach(
          (v) => (v.style.display = "none")
        );
        showView.style.display = "block";
        headerDefault.style.display = title ? "none" : "flex";
        headerDetails.style.display = title ? "flex" : "none";
        if (title) headerTitle.textContent = title;
      }
      function goToUploadView() {
        switchView(uploadView, "영수증 업로드 및 확인");
      }
      function goToChatView() {
        switchView(chatbotView, "가계부 비서 영식이");
        if (chatHistory.length === 0) {
          addMessageToChatBox(
            "안녕하세요! 저는 가계부 비서 '영식이'입니다. 🤖\n현재 세션에 업로드된 영수증에 대해 질문하거나, 일상적인 대화를 나눠보세요!",
            "bot"
          );
        }
      }

      headerDetails
        .querySelector(".back-button")
        .addEventListener("click", () => {
          if (chatbotView.style.display === "block") {
            switchView(uploadView, "영수증 업로드 및 확인");
          } else {
            switchView(countryView);
            currentSessionData = [];
            resultsContainer.innerHTML = "";
            postUploadActions.style.display = "none";
            chatHistory = [];
          }
        });
      document.querySelectorAll(".go-to-chat-btn").forEach((button) => {
        button.addEventListener("click", goToChatView);
      });

      document
        .getElementById("generate-report-btn")
        .addEventListener("click", generateReport);
      document
        .getElementById("chat-send-btn")
        .addEventListener("click", sendTextMessage);
      chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendTextMessage();
      });
      document
        .getElementById("ledger-modal-close-btn")
        .addEventListener("click", () => {
          reportModal.style.display = "none";
          activeCharts.forEach((c) => c.destroy());
        });

      async function processFiles(files) {
        if (!files.length) return;
        loadingText.textContent = `영수증 ${files.length}개 처리 중...`;
        loadingOverlay.style.display = "flex";

        for (const file of files) {
          const formData = new FormData();
          formData.append("receiptImage", file); // app.py의 request.files['receiptImage']와 일치

          try {
            const response = await fetch("/upload", {
              // app.py의 /upload API 호출
              method: "POST",
              body: formData,
            });

            // response.ok가 아닐 때도 JSON 파싱을 시도 (에러 메시지를 받기 위해)
            const data = await response.json();

            if (!response.ok) {
              // 서버가 보낸 에러 메시지를 사용
              throw new Error(
                data.error || "서버 처리 중 알 수 없는 오류 발생"
              );
            }

            // 성공 시 로직
            currentSessionData.push({
              data: data.receiptData,
              filename: data.filename,
            });
            resultsContainer.insertAdjacentHTML(
              "beforeend",
              createReceiptCardHTML(data.receiptData, data.filename)
            );

            // 업로드된 영수증이 하나 이상 있으면
            if (currentSessionData.length > 0) {
              // 1. 하단 버튼 그룹을 보여줍니다.
              postUploadActions.style.display = "flex";

              // 2. 상단 버튼 그룹을 숨깁니다.
              document.getElementById("pre-upload-actions").style.display =
                "none";

              // 3. (선택사항) '영수증 업로드' 버튼 텍스트를 변경합니다.
              document.querySelector('label[for="file-input"]').innerHTML =
                "📂 영수증 추가하기";
            }
          } catch (error) {
            // 실패 시 에러 카드 표시
            resultsContainer.insertAdjacentHTML(
              "beforeend",
              `<div class="receipt-card"><h2>${file.name} 처리 실패</h2><p style="color:red;padding:15px;">${error.message}</p></div>`
            );
          }
        }
        loadingOverlay.style.display = "none";
      }

      function createReceiptCardHTML(data, filename) {
        let itemsHTML = data.items
          .map(
            (item, index) =>
              `<div class="info-item" data-item-index="${index}"><span class="editable" data-field="itemName">${item.name}</span><span><span class="editable" data-field="itemPrice">${item.price}</span> ${data.currency}</span></div>`
          )
          .join("");
        return `<div class="receipt-card" data-filename="${filename}"><div class="receipt-card-header"><h2><span class="editable" data-field="merchantName">${data.merchantName}</span></h2><div class="card-actions"><button class="edit-btn">수정</button><button class="save-btn">저장</button><button class="delete-btn">삭제</button></div></div><div class="receipt-card-body"><div class="info-item"><label>거래일:</label><span class="editable" data-field="transactionDate">${data.transactionDate}</span></div><h4 style="margin:15px 0 5px; font-weight:500;">구매 품목</h4><div class="item-list">${itemsHTML}</div><div class="info-item-total"><strong>총액:</strong><strong><span class="editable" data-field="total">${data.total}</span> ${data.currency}</strong></div></div></div>`;
      }

      resultsContainer.addEventListener("click", async (e) => {
        const card = e.target.closest(".receipt-card");
        if (!card) return;
        if (e.target.classList.contains("delete-btn")) {
          if (!confirm("이 영수증을 영구적으로 삭제하시겠습니까?")) return;
          const filename = card.dataset.filename;
          loadingOverlay.style.display = "flex";
          try {
            const response = await fetch("/delete-receipt", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ filename }),
            });
            if (!response.ok) throw new Error("서버 삭제 실패");
            currentSessionData = currentSessionData.filter(
              (item) => item.filename !== filename
            );
            card.remove();
          } catch (error) {
            alert(`삭제 실패: ${error.message}`);
          } finally {
            loadingOverlay.style.display = "none";
          }
        }
        if (e.target.classList.contains("edit-btn")) {
          card.querySelectorAll(".editable").forEach((span) => {
            const input = document.createElement("input");
            input.type = "text";
            input.value = span.textContent;
            input.className = "editable-input";
            span.style.display = "none";
            span.parentNode.insertBefore(input, span.nextSibling);
          });
          e.target.style.display = "none";
          card.querySelector(".save-btn").style.display = "inline-block";
        }
        if (e.target.classList.contains("save-btn")) {
          const filename = card.dataset.filename;
          const sessionItem = currentSessionData.find(
            (item) => item.filename === filename
          );
          if (!sessionItem) return;
          card.querySelectorAll(".editable").forEach((span) => {
            const input = span.nextSibling;
            const newValue = input.value;
            const field = span.dataset.field;
            span.textContent = newValue;
            span.style.display = "inline";
            input.remove();
            if (field === "merchantName")
              sessionItem.data.merchantName = newValue;
            else if (field === "transactionDate")
              sessionItem.data.transactionDate = newValue;
            else if (field === "total") sessionItem.data.total = newValue;
            else if (field === "itemName" || field === "itemPrice") {
              const itemIndex = span.closest(".info-item").dataset.itemIndex;
              const key = field === "itemName" ? "name" : "price";
              sessionItem.data.items[itemIndex][key] = newValue;
            }
          });
          e.target.style.display = "none";
          card.querySelector(".edit-btn").style.display = "inline-block";
        }
      });

      async function sendTextMessage() {
        const prompt = chatInput.value.trim();
        if (!prompt) return;
        addMessageToChatBox(prompt, "user");
        chatInput.value = "";
        addMessageToChatBox("생각 중... 🤖", "bot", true);
        try {
          const payload = {
            prompt: prompt,
            session_data: currentSessionData,
            history: chatHistory,
          };
          const response = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await response.json();
          document.getElementById("thinking-msg")?.remove();
          if (!response.ok) throw new Error(data.error);
          addMessageToChatBox(data.response, "bot");
          chatHistory.push({ role: "user", content: prompt });
          chatHistory.push({ role: "assistant", content: data.response });
        } catch (error) {
          document.getElementById("thinking-msg")?.remove();
          addMessageToChatBox(`챗봇 오류: ${error.message}`, "bot");
        }
      }

      function addMessageToChatBox(message, sender, isThinking = false) {
        if (isThinking) document.getElementById("thinking-msg")?.remove();
        const msgEl = document.createElement("div");
        msgEl.className = `chat-message ${sender}-message`;
        msgEl.textContent = message;
        if (isThinking) msgEl.id = "thinking-msg";
        chatBox.appendChild(msgEl);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      async function generateReport() {
        if (currentSessionData.length === 0)
          return alert(
            "분석할 영수증이 없습니다.\n먼저 영수증을 업로드해주세요."
          );

        loadingText.textContent = "리포트를 생성하고 있습니다...";
        loadingOverlay.style.display = "flex";

        try {
          const response = await fetch("/generate-web-report", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(currentSessionData),
          });
          const data = await response.json();
          if (!response.ok) throw new Error(data.error);

          activeCharts.forEach((c) => c.destroy());
          activeCharts = [];
          reportBody.innerHTML = "";

          if (Object.keys(data).length === 0) {
            reportBody.innerHTML =
              '<p style="text-align:center;">분석할 지출 내역이 없습니다.</p>';
          } else {
            for (const currency in data) {
              const reportData = data[currency];

              // [수정] 1. 통화별 리포트 전체를 감싸는 최상위 컨테이너 생성
              const reportContainer = document.createElement("div");
              reportContainer.style.marginBottom = "30px"; // 리포트 간 간격 추가

              // 2. 제목 생성 (이전 코드와 거의 동일)
              const titleElement = document.createElement("h4"); // h5보다 h4가 더 적합
              const krwTotalFormatted = Math.round(
                reportData.total_krw
              ).toLocaleString();
              titleElement.innerHTML = `${currency} 지출 <br> 총액: ${reportData.total_orig.toFixed(
                2
              )} ${currency} / ₩${krwTotalFormatted}<br><span style="font-size: 13px; color: #666; font-weight: 400;">적용환율: 1 ${currency} = ${
                reportData.exchange_rate
              }원</span>`;
              titleElement.style.textAlign = "left";
              titleElement.style.fontWeight = "500";
              titleElement.style.lineHeight = "1.5";
              titleElement.style.marginBottom = "15px";

              // 3. [수정] 테이블과 차트만 담을 '그리드 컨테이너' 별도 생성
              const contentGrid = document.createElement("div");
              contentGrid.className = "report-section"; // 나란히 배치하는 스타일은 여기에만 적용

              const tableHtml = `
                    <div class="report-table-container">
                        <table class="report-table">
                            <thead><tr><th>카테고리</th><th class="price-col">금액</th><th class="price-col">원화(₩)</th></tr></thead>
                            <tbody>
                                ${reportData.table_data
                                  .map(
                                    (r) => `
                                    <tr>
                                        <td>${r.카테고리}</td>
                                        <td class="price-col">${r.가격.toFixed(
                                          2
                                        )}</td>
                                        <td class="price-col">${Math.round(
                                          r.원화가격
                                        ).toLocaleString()}</td>
                                    </tr>`
                                  )
                                  .join("")}
                                <tr>
                                    <th>총합</th>
                                    <td class="price-col">${reportData.total_orig.toFixed(
                                      2
                                    )}</td>
                                    <td class="price-col">${Math.round(
                                      reportData.total_krw
                                    ).toLocaleString()}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>`;

              const chartContainer = document.createElement("div");
              chartContainer.className = "report-chart-container";
              const canvas = document.createElement("canvas");
              chartContainer.appendChild(canvas);

              // [수정] 4. 조립 순서 변경
              contentGrid.insertAdjacentHTML("beforeend", tableHtml); // 그리드에 테이블 추가
              contentGrid.appendChild(chartContainer); // 그리드에 차트 추가

              reportContainer.appendChild(titleElement); // 전체 컨테이너에 제목을 맨 위에 추가
              reportContainer.appendChild(contentGrid); // 전체 컨테이너에 그리드를 아래에 추가

              reportBody.appendChild(reportContainer); // 최종적으로 조립된 리포트를 모달에 추가

              activeCharts.push(
                new Chart(canvas.getContext("2d"), {
                  type: "pie",
                  data: {
                    labels: reportData.chart_labels,
                    datasets: [
                      {
                        data: reportData.chart_data,
                        backgroundColor: [
                          "#d946ef",
                          "#f97316",
                          "#14b8a6",
                          "#3b82f6",
                          "#8b5cf6",
                          "#ef4444",
                          "#84cc16",
                        ],
                        borderColor: "#fff",
                      },
                    ],
                  },
                  options: {
                    responsive: true,
                    plugins: { legend: { position: "right" } },
                  },
                })
              );
            }
          }
          reportModal.style.display = "flex";
        } catch (error) {
          alert(`리포트 생성 실패: ${error.message}`);
        } finally {
          loadingOverlay.style.display = "none";
        }
      }

      document
        .getElementById("all-modal-close-btn")
        .addEventListener("click", () => {
          ledgerModal.style.display = "none";
        });

      document.querySelectorAll(".show-ledger-btn").forEach((button) => {
        button.addEventListener("click", showFullLedger);
      });

      let fullLedgerData = {};

      async function showFullLedger() {
        loadingText.textContent = "전체 가계부를 불러오는 중...";
        loadingOverlay.style.display = "flex";
        try {
          const response = await fetch("/get-ledger");
          const data = await response.json();
          if (!response.ok) throw new Error(data.error);

          fullLedgerData = data; // 받아온 데이터를 전역 변수에 저장

          // 드롭다운 메뉴 채우기
          const countryFilter = document.getElementById("country-filter");
          countryFilter.innerHTML = '<option value="전체">전체 보기</option>'; // 기본 옵션

          for (const country in fullLedgerData) {
            const option = document.createElement("option");
            option.value = country;
            option.textContent = country;
            countryFilter.appendChild(option);
          }

          // 드롭다운에 이벤트 리스너 추가 (한 번만)
          // 이전에 추가된 리스너가 있다면 중복을 막기 위해 아래와 같이 처리할 수 있습니다.
          countryFilter.replaceWith(countryFilter.cloneNode(true)); // 리스너 초기화
          document
            .getElementById("country-filter")
            .addEventListener("change", (e) => {
              displayLedgerByCountry(e.target.value);
            });

          // 처음에는 전체 데이터를 보여줌
          displayLedgerByCountry("전체");

          ledgerModal.style.display = "flex";
        } catch (error) {
          alert(`가계부 로딩 실패: ${error.message}`);
        } finally {
          loadingOverlay.style.display = "none";
        }
      }

      // 데이터를 화면에 그려주는 함수 (업그레이드됨)
      function displayLedgerByCountry(selectedCountry) {
        const ledgerBody = document.getElementById("ledger-body");
        ledgerBody.innerHTML = ""; // 이전 내용 비우기

        if (Object.keys(fullLedgerData).length === 0) {
          ledgerBody.innerHTML =
            '<p style="text-align:center;">처리된 데이터가 없습니다.</p>';
          return;
        }

        const countriesToShow =
          selectedCountry === "전체"
            ? Object.keys(fullLedgerData)
            : [selectedCountry];

        countriesToShow.forEach((country) => {
          if (!fullLedgerData[country]) return;

          const countryData = fullLedgerData[country];
          const countryTotalOrig = countryData.total_orig.toFixed(2);
          const countryTotalKRW = Math.round(
            countryData.total_krw
          ).toLocaleString();

          const countrySection = document.createElement("div");
          // h3 제목에 현지 통화 총액과 원화 총액을 모두 표시
          countrySection.innerHTML = `
            <h3 style="margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
                ${country} (총 지출: ${countryTotalOrig} ${
            countryData.currency
          } / ₩${countryTotalKRW})
            </h3>
            <table class="report-table" style="width: 100%;">
                <thead>
                    <tr>
                        <th>카테고리</th>
                        <th class="price-col">현지 금액</th>
                        <th class="price-col">원화(₩) 합계</th>
                    </tr>
                </thead>
                <tbody>
                    ${countryData.data
                      .map(
                        (item) => `
                            <tr>
                                <td>${item.category}</td>
                                <td class="price-col">${item.total_orig.toFixed(
                                  2
                                )} ${countryData.currency}</td>
                                <td class="price-col">${Math.round(
                                  item.total_krw
                                ).toLocaleString()}</td>
                            </tr>
                        `
                      )
                      .join("")}
                    <tr style="font-weight: bold; border-top: 2px solid #ddd;">
                        <td>총합</td>
                        <td class="price-col">${countryTotalOrig} ${
            countryData.currency
          }</td>
                        <td class="price-col">₩${countryTotalKRW}</td>
                    </tr>
                </tbody>
            </table>
        `;
          ledgerBody.appendChild(countrySection);
        });
      }
    </script>
    <footer
      style="text-align: center; padding: 20px; font-size: 12px; color: #888"
    >
      영식이(YoungSeek)이가 더 똑똑해질 수 있도록 도와주세요! 발견한 오류나 개선
      아이디어를
      <a
        href="mailto:your_email@example.com"
        style="color: #555; text-decoration: none"
      >
        YoungSeekJJang@microsoftaischool.com
      </a>
      으로 보내주세요!
    </footer>
  </body>
</html>
